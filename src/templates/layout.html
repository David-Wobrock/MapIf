<!DOCTYPE html>
<html lang="fr">
<head>
	<title>MapIF</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	{% block css %}
	<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700">
  	<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/icon?family=Material+Icons">
	<!-- CSS -->
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='libs/bootstrap-3.3.6/css/bootstrap.min.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='libs/bootstrap-material-design/css/bootstrap-material-design.min.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='libs/bootstrap-material-design/css/ripples.min.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='libs/leaflet/leaflet.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='libs/leaflet/MarkerCluster.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='libs/leaflet/MarkerCluster.Default.css') }}">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='libs/snackbar2/snackbar.css') }}"></link>
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">

	<link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">

	{% endblock %}
	<script src='https://www.google.com/recaptcha/api.js'></script>
</head>
<body>
	{% block body %}
	<nav class="navbar navbar-inverse noselect">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-inverse-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="javascript:void(0)">MapIF</a>
			</div>
			<div id="main-navbar" class="navbar-collapse collapse navbar-inverse-collapse">
				<ul class="nav navbar-nav">
					<li id="menu-map" class="navbar-left-item active"><a href="javascript:void(0)">Carte</a></li>
					<li id="menu-search" class="navbar-left-item"><a href="javascript:void(0)">
						{% if session.user %}
							{% if user_locations[0] is not defined %}
								Ajouter une localisation
							{% else %}
								Changer ma localisation
							{% endif %}
						{% else %}
							Rechercher
						{% endif %}</a></li>
					<li id="menu-about" class="navbar-left-item"><a href="javascript:void(0)" data-toggle="modal" data-target="#aboutModal">À propos</a></li>
					{% if session.user %}
					<li id="menu-profil" class="navbar-left-item"><a href="javascript:void(0)" data-toggle="modal" data-target="#profilModal">Profil</a></li>
					{% endif %}
				</ul>
				<ul class="nav navbar-nav navbar-right">
					{% if not session.user %}
					<li><a href="javascript:void(0)" data-toggle="modal" data-target="#inscriptionModal">S'inscrire</a></li>
					<li><a href="javascript:void(0)" data-toggle="modal" data-target="#connexionModal">Connexion</a></li>
					{% else %}
					<li><a href="{{ url_for('logout') }}">Deconnexion</a></li>
					{% endif %}
				</ul>
			</div>
		</div>
	</nav>

	<div id="page-content" class="container-fluid">
		<div id="page-wrapper">
			<div id="left-panel" class="closePanel">
				<div id="left-panel-content">
					<div id="left-panel-form">
						<h4>Trouver un lieu</h4>
						<div class="form-group label-floating">
							<label class="control-label" for="addr-search-input-city">Ville</label>
							<input class="form-control" id="addr-search-input-city" type="text">
						</div>
						<div class="form-group label-floating">
							<label class="control-label" for="addr-search-input-country">Pays</label>
							<input class="form-control" id="addr-search-input-country" type="text">
						</div>
						<a href="#" id="addr-search-submit" class="fab btn btn-default btn-fab btn-raised"><i class="material-icons">search</i></a>
					</div>
					<div id="left-panel-result">
						<div id="search-results"></div>
					</div>
				</div>
				<div class="widget-pane-toggle-button-container"><button type="button" class="btn btn-raised btn-xs" data-toggle="tooltip" data-placement="right" title="&Eacute;tendre le panneau latéral" data-original-title="Tooltip on right"><span class="glyphicon glyphicon-triangle-right"></span></button> </div>
			</div>
			<div id="mymap"></div>
		</div>
	</div>
	{% endblock %}
	<!-- connexion modal -->
	<div class="modal fade" id="connexionModal" tabindex="-1" role="dialog" aria-labelledby="connexion">
		<div class="modal-dialog" role="document">
			<div class="modal-content">

				<form id="form-connexion">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="connexion">Connexion</h4>
					</div>
					<div class="modal-body">
						<div class="form-group label-floating">
							<label for="form-connexion-input-username" class="control-label">E-mail</label>
							<input class="form-control" id="form-connexion-input-username" name="email" required="required" type="text">
							<span class="help-block">Bon si vous êtes pas trop bête vous vous en souvenez...</span>
						</div>

						<div class="form-group label-floating">
							<label for="form-connexion-input-password" class="control-label">Mot de passe</label>
							<input class="form-control" id="form-connexion-input-password" type="password" name="password" required="required">
							<span class="help-block">Si vous avez oublié votre mot de passe veuillez <abbr title="Oui, j'ai la flemme de dev un truc comme ça...">ne pas en redemander un</abbr></span>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
						<button type="submit" class="btn btn-primary">Se connecter</button>
					</div>
				</form>
			</div>
		</div>
	</div>


	<!-- inscription modal -->
	<div class="modal fade" id="inscriptionModal" tabindex="-1" role="dialog" aria-labelledby="inscription">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<form id="form-inscription">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="inscription">Inscription</h4>
					</div>
					<div class="modal-body">
						<div class="form-group label-floating">
							<label for="form-inscription-input-firstname" class="control-label">Prénom</label>
							<input class="form-control" id="form-inscription-input-firstname" name="firstname" required="required" type="text">
							<span class="help-block">Vous avez bien un nom ? non ?</span>
						</div>
						<div class="form-group label-floating">
							<label for="form-inscription-input-lastname" class="control-label">Nom</label>
							<input class="form-control" id="form-inscription-input-lastname" name="lastname" required="required" type="text">
							<span class="help-block">C'est bon, c'est bon, je demanderai pas le téléphone...</span>
						</div>
						<div class="form-group label-floating">
							<label for="form-inscription-input-email" class="control-label">Email</label>
							<input class="form-control" id="form-inscription-input-email" name="email" required="required" type="email">
							<span class="help-block">Au fait on a un sponsor avec quelques sites peu recommandables, ça vous dérange pas ? Je préfère prévenir hein...</span>
						</div>
						<div class="form-group label-floating">
							<label for="form-inscription-input-password1" class="control-label">Mot de passe</label>
							<input class="form-control" id="form-inscription-input-password1" name="password1" required="required" type="password">
							<span class="help-block">Un mot de passe c'est important !</span>
						</div>
						<div class="form-group label-floating">
							<label for="form-inscription-input-password2" class="control-label">Répetez le mot de passe</label>
							<input class="form-control" id="form-inscription-input-password2" name="password2" required="required" type="password">
							<span class="help-block">Mais s'en rappeler c'est mieux !</span>
						</div>
						<div id="p3-block" class="form-group label-floating">
							<label for="form-inscription-input-password3" class="control-label">Répetez encore le mot de passe</label>
							<input class="form-control" id="form-inscription-input-password3" type="password">
							<span class="help-block">On est jamais trop prudent !</span>
						</div>
						<div id="p3-msg" class="alert alert-dismissible alert-success">
							<button type="button" class="close" data-dismiss="alert">×</button>
							<strong>Ouaiiiiiis !</strong> Bon par contre ça servait à rien ... Merci quand même !
						</div>
						<div class="form-group">
							<label for="form-inscription-input-promo" class="control-label">Année <del>d'obtention du diplôme</del> de promo</label>
							<select class="form-control" id="form-inscription-input-promo" name="promo" required="required">
							</select>
							<span class="help-block">La fameuse 6IF... !</span>
						</div>
						<div class="g-recaptcha" data-sitekey="6Lc_cCATAAAAAB0j0KykFgsWtlN4KtWrX1iYD8Nz"></div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
						<button type="submit" class="btn btn-primary">S'inscrire</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- About modal -->
	<div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="about">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="about">À propos de MapIf</h4>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-sm-6">
							<h5>MapIf <small>Version <span class="version">X.X.X</span></small></h5>
							<p>
								Ce projet est né de l'esprit de quelques 4IF de la promo 2017, au moment critique qu'est le 
								stage, veille du départ en échange pour une majorité d'entre eux. Cette
								épreuve qu'est la séparation n'étant pas facile à vivre, ils ont décidé de 
								développer cette petite application permettant d'avoir une idée précise 
								(mais pas trop <a href="https://twitter.com/search?q=%23Stalking" target="_blank">#Stalking</a> 
								<a href="https://twitter.com/search?q=%23NSA" target="_blank">#NSA</a>) 
								des endroits où se trouvent leurs amis et où ils
								se trouvent eux mêmes (juste en cas de perte de mémoire <a href="https://twitter.com/search?q=%23FinDeSoiréeDifficile" target="_blank">#FinDeSoiréeDifficile</a>).
							</p>
							<p>
								Bon vent les IF !
							</p>
							<hr/>
							<h5>Contributeurs</h5>
							<p>
								Nous espérons que cette petite appli vous comblera. N'hésitez pas à nous suggérer 
								des améliorations nous serons toujours disposés à vous écouter. <a href="https://twitter.com/search?q=%23IngénieurHumaniste" target="_blank">#IngénieurHumaniste</a>
							</p>
							<p>
								Si vous n'êtes pas content de cette application veuillez ne pas nous le signaler. Merci. 
								<a href="https://twitter.com/search?q=%23RaisonablementHumaniste" target="_blank">#RaisonablementHumaniste</a>
							</p>
							<p>	
								Rendez vous dans la section <a href="#contribute">Contribuer</a> si vous êtes un (vrai) IF.
								<a href="https://twitter.com/search?q=%23Geek" target="_blank">#Geek</a>
								<a href="https://twitter.com/search?q=%23Insomnie" target="_blank">#Insomnie</a>
								<a href="https://twitter.com/search?q=%23ViveLesClichés" target="_blank">#ViveLesClichés</a>
							</p>
							<ul>
								<li><a href="https://github.com/LoicTouzard" target="_blank">Loïc Touzard</a> - 4IF 2017</li>
								<li><a href="https://github.com/niosega" target="_blank">Nicolas Bonfante</a> - 4IF 2017</li>
								<li><a href="https://github.com/KevinBulme" >Kévin Bulmé</a> - 4IF 2017</li>
								<li><a href="https://github.com/pdautry" target="_blank">Paul Dautry</a> - 4IF 2017</li>
							</ul>
							<hr/>
							<h5 id="contribute">Contribuer</h5>
							<p>
								Vous pouvez à tout moment forker le <a href="https://github.com/LoicTouzard/MapIf" target="_blank">dépôt</a> sur Github.<br>
								Si vous avez <strong>des problèmes ou des propositions</strong> n'hésitez pas à créer une <a href="https://github.com/LoicTouzard/MapIf/issues" target="_blank">issue</a> pour le projet.
							</p>
							<hr class="visible-xs"/>
						</div>
						<div class="col-sm-6">
							<h5>Mode d'emploi</h5>
								<p>
									Pour commencer, vous devez créer un compte en cliquant sur le bouton <b class="menu-ref">S'inscrire</b> 
									en haut à droite de la fenêtre. Si vous possédez déjà un compte, connectez vous en cliquant sur le bouton 
									<b class="menu-ref">Connexion</b> dans cette même zone du menu.
								</p>
								<p>
									Une fois connecté, vous aurez la possibilité d'ajouter une première localisation à votre profil en cliquant sur 
									le bouton <b class="menu-ref">Rechercher</b> à gauche dans le menu. Renseignez la ville et le pays où elle 
									se trouve et cliquez sur le bouton avec la loupe. Une fois la recherche effectuée, sélectionnez le résultat le 
									plus pertinent selon vous et cliquez sur le bouton marqué d'un plus. 
								</p>
								<p>
									Ce premier lieu, une fois ajouté, apparaitra sur la carte sous la forme d'un <b>marqueur</b>.
								</p>
								<p>
									Il vous sera alors possible d'<b>ajouter une localisation à tout moment</b> toujours en cliquant sur le bouton 
									<b class="menu-ref">Rechercher</b> dans le menu. Ces lieux seront mémorisés datés tel un historique, afin de permettre 
									à vous et vos amis de suivre votre parcours.
								</p>
								<p>
									Vous pourrez à tout moment vous désinscrire du site. Attention, cette désinscription n'est pas maquillée !
									Contrairement à certains réseaux sociaux, <b>l'intégralité des données vous concernant seront effacées</b>. 
									Cette opération est <b class="danger">irrémédiable</b>, réfléchissez donc bien avant de cliquer sur le 
									<b class="danger">bouton rouge</b> dans la fenêtre accessible en cliquant sur le bouton <b class="menu-ref">Profil</b>.
								</p>
								<p>
									<b class="danger">Attention:</b><span class="danger"> le site n'est pas sécurisé HTTPS (parce que l'hébergement est gratuit). Il est donc vivement conseillé d'utiliser un mot de passe unique pour ce site vulnérable aux attaques de type MITM.</span>
								</p>
								<p>
									<b>Note:</b> le mot de passe stocké dans notre base de données est tout de même hashé.
								</p>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
				</div>
			</div>
		</div>
	</div>

	{% if session.user is defined %}
	<!-- Confirmation add position modal -->
	<div class="modal fade" id="positionModal" tabindex="-1" role="dialog" aria-labelledby="position">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="position">Définir un nouvelle position</h4>
				</div>
				<div class="modal-body">
				{% for loc in user_locations[-5:] | reverse %}
					{% if loop.first %}
					<h5>Votre position actuelle est {{ loc.location.city }} {{ loc.location.country }} depuis le {{ loc.timestamp.strftime('%d %B %Y') }}</h5>
					{% else %}
						{% if loop.last and loop.index is equalto 5 %}
					<p>...</p>
						{% else %}
					<p>Vous étiez à {{ loc.location.city }} {{ loc.location.country }} le {{ loc.timestamp.strftime('%d %B %Y') }}</p>
						{% endif %}
					{% endif %}
				{% else %}
					<p>Vous n'avez pas encore défini votre position</p>
				{% endfor %}

					<p class="well">Voulez vous ajouter <strong><span id="position-add-city">city</span> <span id="position-add-country">COUNTRY</span></strong> à votre historique de déplacement ?</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
					<button id="change-current-position-validate" type="button" class="btn btn-primary">Changer ma position actuelle</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Profil modal -->
	<div class="modal fade" id="profilModal" tabindex="-1" role="dialog" aria-labelledby="profil">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="profil">Mon profil</h4>
				</div>
				<div class="modal-body">
					<a href="https://www.facebook.com/"><img id="fb-logo" class="img-responsive center-block" src="{{ url_for('static', filename='image/goto_facebook.png') }}" alt="go to facebook !"></a>
					<div id="delete-account-panel" class="panel panel-danger">
					  <div class="panel-heading">
					    <h3 class="panel-title">Danger !</h3>
					  </div>
					  <div class="panel-body">
					    <p class="text-danger">Attention la suppression du compte entraine la suppression <strong>definitive</strong> de toutes les données qui y sont liées ...</p>
					    <div class="form-group has-error">
						  <label class="control-label" for="delete-input">Ecrivez : "<em>je sui 1 gro boloss</em>"</label>
						  <div class="input-group">
						    <input id="delete-input" class="form-control" type="text" pattern="je sui 1 gro boloss" required placeholder="C'est qui le boloss ?" >
						    <span class="input-group-btn">
						        <button id="delete-button-confirm" disabled="disabled" class="btn btn-raised btn-danger">Supprimer définitivement mon compte</button>
						    </span>
						  </div>
						</div>
					  </div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
				</div>
			</div>
		</div>
	</div>
	{% endif %}

	{% block scripts %}
	<!-- Javascript Libs -->
	<script type="text/javascript" src="{{ url_for('static', filename='libs/jquery-2.2.3/jquery-2.2.3.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='libs/bootstrap-3.3.6/js/bootstrap.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='libs/bootstrap-material-design/js/material.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='libs/bootstrap-material-design/js/ripples.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='libs/leaflet/leaflet.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='libs/leaflet/leaflet.markercluster.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='libs/js-cookie/js-cookie.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='libs/snackbar2/snackbar.js') }}"></script>

	<!-- Personnal -->
	<script type="text/javascript">
		//javascript data
		var locations = [];
		{% for lu in locations %}
		locations.push({
			location:{
				lat:{{ lu.location.lat }},
				lon:{{ lu.location.lon }},
				city:"{{ lu.location.city }}",
				country:"{{ lu.location.country }}"
			},
			users:[
			{% for u in lu.users %}
				{
					firstname:"{{ u.firstname }}",
					lastname:"{{ u.lastname }}"
				}{% if not loop.last %},{% endif %}
			{% endfor %}
			]
		});
		{% endfor %}

		{# COMMENTED
			var users = [];
			{% for user in users %}
			console.log("{{ user }}");
			{% if user.location.data %}
			users.push({
				id: "{{ user.user.id }}",
				firstname: "{{ user.user.firstname }}",
				lastname: "{{ user.user.lastname }}",
				promo: "{{ user.user.promo }}",
				lat: "{{ user.location.data.lat }}",
				lon: "{{ user.location.data.lon }}"
			});
			{% endif %}
			{% endfor %}
			// console.log(users);
		#}
		//cant "var connected = {{ session.user is defined }};" Because python and javascript boolean are different : "False" and "false"
		{% if session.user is defined %}
		var connected = true;
		{% else %}
		var connected = false;
		{% endif %}
		console.log("connected : "+connected)
	</script>
	<script type="text/javascript" src="{{ url_for('static', filename='js/main.js') }}"></script>
	<script type="text/javascript">
		// Load configuration script and trigger page scripts
		SETTINGS = {};
		$(function(){			
			$.getJSON("{{ url_for('static', filename='settings.json') }}",function(data){
				SETTINGS = data;
				SETTINGS.GEOPOSITIONS = {
					'INSALYON': new L.LatLng(45.7832543, 4.8780048),
					'WORLD_SOUTHWEST': new L.LatLng(-85, -180),
					'WORLD_NORTHEAST': new L.LatLng(85, 180)
				},
				$("body").trigger("settings-loaded");
			});
		});
	</script>
	{% endblock %}
</body>
</html>
